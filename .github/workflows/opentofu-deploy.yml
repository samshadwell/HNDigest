name: OpenTofu Deploy

on:
  workflow_dispatch:
  push:
    branches: [main]
    paths:
      - "infrastructure/**"
      - ".github/workflows/opentofu-deploy.yml"
  pull_request:
    branches: [main]
    paths:
      - "infrastructure/**"
      - ".github/workflows/opentofu-deploy.yml"

# On main: only one workflow at a time (queue, don't cancel)
# On PRs: each PR runs independently
concurrency:
  group: ${{ github.event_name == 'push' && 'cd-main' || format('cd-pr-{0}', github.event.number) }}
  cancel-in-progress: false

permissions:
  id-token: write
  contents: read
  pull-requests: write

env:
  AWS_REGION: us-west-2
  TF_VAR_create_github_oidc_provider: false
  TF_VAR_ses_from_email: ${{ vars.SES_FROM_EMAIL }}
  TF_VAR_ses_reply_to_email: ${{ vars.SES_REPLY_TO_EMAIL }}
  TF_VAR_ses_staging_from_email: ${{ vars.SES_STAGING_FROM_EMAIL }}

jobs:
  plan:
    name: "Plan"
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: infrastructure
    outputs:
      has_changes: ${{ steps.plan.outputs.has_changes }}
    steps:
      - uses: actions/checkout@v6

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: ${{ vars.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Install OpenTofu
        uses: opentofu/setup-opentofu@v1
        with:
          tofu_wrapper: false

      - name: Initialize
        run: tofu init

      - name: Plan
        id: plan
        run: |
          set +e
          tofu plan -detailed-exitcode -out=tfplan > plan_output.txt 2>&1
          EXIT_CODE=$?
          set -e

          cat plan_output.txt

          if [ $EXIT_CODE -eq 0 ]; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
          elif [ $EXIT_CODE -eq 2 ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
          else
            echo "Plan failed with exit code $EXIT_CODE"
            exit 1
          fi

      - name: Upload plan artifact
        if: steps.plan.outputs.has_changes == 'true'
        uses: actions/upload-artifact@v6
        with:
          name: tfplan
          path: infrastructure/tfplan
          retention-days: 1

      - name: Comment on PR
        if: github.event_name == 'pull_request' && steps.plan.outputs.has_changes == 'true'
        uses: actions/github-script@v8
        with:
          script: |
            const fs = require('fs');
            const planOutput = fs.readFileSync('infrastructure/plan_output.txt', 'utf8');

            // Extract just the summary (last ~50 lines or the part after "Plan:")
            const lines = planOutput.split('\n');
            const planIndex = lines.findIndex(l => l.includes('Plan:'));
            const summary = planIndex >= 0
              ? lines.slice(Math.max(0, planIndex - 10)).join('\n')
              : lines.slice(-50).join('\n');

            // Strip ANSI escape codes
            const cleanSummary = summary.replace(/\u001b\[[0-9;]*m/g, '');

            const body = `### OpenTofu Plan

            This PR includes infrastructure changes. Please review the plan before merging.

            <details>
            <summary>Plan Summary</summary>

            \`\`\`
            ${cleanSummary.slice(0, 60000)}
            \`\`\`

            </details>

            > Run \`tofu plan\` locally for the full output.`;

            // Check for existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(c =>
              c.user.type === 'Bot' && c.body.includes('### OpenTofu Plan')
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }

  apply:
    name: "Apply"
    needs: plan
    if: github.event_name == 'push' && needs.plan.outputs.has_changes == 'true'
    runs-on: ubuntu-latest
    environment: production
    defaults:
      run:
        working-directory: infrastructure
    steps:
      - uses: actions/checkout@v6

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: ${{ vars.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Install OpenTofu
        uses: opentofu/setup-opentofu@v1

      - name: Initialize
        run: tofu init

      - name: Download plan artifact
        uses: actions/download-artifact@v7
        with:
          name: tfplan
          path: infrastructure

      - name: Apply
        run: tofu apply -auto-approve tfplan
