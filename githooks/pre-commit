#!/bin/bash
set -eu

if git status --short | grep --quiet '^MM'; then
  printf '%s\n' "ERROR: Some staged files have unstaged changes" >&2
  printf '%s\n' "Please either stage or stash those changes before committing." >&2
  exit 1;
fi

# Get staged Rust files
STAGED_RS_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.rs$' || true)
if [ -n "$STAGED_RS_FILES" ]; then
    echo "$STAGED_RS_FILES" | xargs cargo fmt --
    echo "$STAGED_RS_FILES" | xargs git add
fi

# Get staged OpenTofu files in infrastructure/
STAGED_TF_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '^infrastructure/.*\.tf$' || true)
if [ -n "$STAGED_TF_FILES" ]; then
    echo "$STAGED_TF_FILES" | xargs tofu fmt
    echo "$STAGED_TF_FILES" | xargs git add
fi

git update-index --again
